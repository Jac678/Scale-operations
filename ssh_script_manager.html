<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH脚本管理工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .form-input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none;
            }
            .card-hover {
                @apply hover:shadow-lg transition-shadow duration-300;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark flex items-center">
                <i class="fa fa-terminal text-primary mr-3"></i>
                SSH脚本管理工具
            </h1>
            <p class="text-gray-500 mt-1">批量管理SSH会话和脚本参数配置</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- SSH连接设置 -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-plug text-primary mr-2"></i>
                SSH连接设置
            </h2>
            
            <div class="grid md:grid-cols-3 gap-6">
                <div>
                    <label for="ssh-user" class="block text-sm font-medium text-gray-700 mb-1">SSH用户名</label>
                    <input type="text" id="ssh-user" value="hello" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                </div>
                
                <div>
                    <label for="ssh-ip" class="block text-sm font-medium text-gray-700 mb-1">SSH服务器IP</label>
                    <input type="text" id="ssh-ip" value="192.168.1.87" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                </div>
                
                <div>
                    <label for="ssh-password" class="block text-sm font-medium text-gray-700 mb-1">SSH密码</label>
                    <input type="password" id="ssh-password" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                </div>
            </div>
            
            <div class="mt-4">
                <label for="num-terminals" class="block text-sm font-medium text-gray-700 mb-1">终端数量</label>
                <input type="number" id="num-terminals" value="5" min="1" max="10" 
                    class="w-24 px-4 py-2 border border-gray-300 rounded-md form-input-focus">
            </div>
        </section>
        
        <!-- 脚本参数配置 -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-cogs text-primary mr-2"></i>
                脚本参数配置
            </h2>
            
            <div class="mb-4">
                <label for="script-prefix" class="block text-sm font-medium text-gray-700 mb-1">脚本前缀名称</label>
                <input type="text" id="script-prefix" value="video2gs_" 
                    class="w-48 px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                <p class="text-xs text-gray-500 mt-1">生成的脚本名将为：[前缀]1.sh, [前缀]2.sh, ...</p>
            </div>
            
            <div class="mb-4">
                <label for="working-dir" class="block text-sm font-medium text-gray-700 mb-1">工作目录</label>
                <input type="text" id="working-dir" value="/data/ycy/" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
            </div>
            
            <div class="mb-4">
                <label for="env-command" class="block text-sm font-medium text-gray-700 mb-1">环境激活命令</label>
                <input type="text" id="env-command" value="mamba activate 3dgs" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
            </div>
            
            <div id="script-configs" class="space-y-6">
                <!-- 脚本配置项将通过JavaScript动态生成 -->
            </div>
        </section>
        
        <!-- 操作按钮 -->
        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <button id="generate-configs" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-md transition-colors duration-200 flex items-center justify-center">
                <i class="fa fa-refresh mr-2"></i>
                生成配置项
            </button>
            
            <button id="start-sessions" class="flex-1 bg-secondary hover:bg-secondary/90 text-white font-medium py-3 px-6 rounded-md transition-colors duration-200 flex items-center justify-center">
                <i class="fa fa-play mr-2"></i>
                启动所有会话
            </button>
        </div>
        
        <!-- 状态和日志区域 -->
        <section class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-info-circle text-primary mr-2"></i>
                操作日志
            </h2>
            
            <div id="status-log" class="bg-gray-50 border border-gray-200 rounded-md h-48 p-4 overflow-y-auto text-sm">
                <p class="text-gray-500 italic">准备就绪，请配置参数并启动会话...</p>
            </div>
        </section>
    </main>

    <footer class="bg-dark text-white mt-12 py-6">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>SSH脚本管理工具 &copy; 2025</p>
        </div>
    </footer>

    <script>
        // 生成脚本配置项
        function generateScriptConfigs() {
            const numTerminals = parseInt(document.getElementById('num-terminals').value) || 5;
            const configContainer = document.getElementById('script-configs');
            configContainer.innerHTML = '';
            
            // 添加配置项标题行
            const headerRow = document.createElement('div');
            headerRow.className = 'grid grid-cols-12 gap-4 font-semibold text-sm text-gray-600 pb-2 border-b';
            headerRow.innerHTML = `
                <div class="col-span-2">脚本名称</div>
                <div class="col-span-5">INPUT_DIR</div>
                <div class="col-span-5">OUTPUT_DIR</div>
            `;
            configContainer.appendChild(headerRow);
            
            // 生成每个脚本的配置项
            for (let i = 1; i <= numTerminals; i++) {
                const scriptPrefix = document.getElementById('script-prefix').value || 'video2gs_';
                const scriptName = `${scriptPrefix}${i}.sh`;
                
                const configRow = document.createElement('div');
                configRow.className = 'grid grid-cols-12 gap-4 items-center py-3 border-b last:border-0 card-hover';
                configRow.innerHTML = `
                    <div class="col-span-2 font-medium">${scriptName}</div>
                    <div class="col-span-5">
                        <input type="text" class="input-dir input-input w-full px-3 py-2 border border-gray-300 rounded-md form-input-focus" 
                               placeholder="/path/to/input" data-type="input" data-index="${i}">
                    </div>
                    <div class="col-span-5">
                        <input type="text" class="input-dir input-output w-full px-3 py-2 border border-gray-300 rounded-md form-input-focus" 
                               placeholder="/path/to/output" data-type="output" data-index="${i}">
                    </div>
                `;
                configContainer.appendChild(configRow);
            }
            
            logMessage(`已生成 ${numTerminals} 个脚本配置项`);
        }
        
        // 记录日志消息
        function logMessage(message) {
            const logContainer = document.getElementById('status-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.className = 'mb-1 last:mb-0';
            logEntry.innerHTML = `<span class="text-primary">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 生成并下载bash脚本
        function generateAndDownloadScript() {
            const sshUser = document.getElementById('ssh-user').value;
            const sshIp = document.getElementById('ssh-ip').value;
            const sshPassword = document.getElementById('ssh-password').value;
            const numTerminals = parseInt(document.getElementById('num-terminals').value) || 5;
            const scriptPrefix = document.getElementById('script-prefix').value || 'video2gs_';
            const workingDir = document.getElementById('working-dir').value;
            const envCommand = document.getElementById('env-command').value;
            
            // 验证必要参数
            if (!sshUser || !sshIp || !sshPassword) {
                alert('请填写完整的SSH连接信息');
                return false;
            }
            
            // 收集目录配置
            const dirConfigs = [];
            for (let i = 1; i <= numTerminals; i++) {
                const inputDir = document.querySelector(`.input-input[data-index="${i}"]`).value;
                const outputDir = document.querySelector(`.input-output[data-index="${i}"]`).value;
                
                if (!inputDir || !outputDir) {
                    alert(`请填写第 ${i} 个脚本的输入和输出目录`);
                    return false;
                }
                
                dirConfigs.push({ input: inputDir, output: outputDir });
            }
            
            // 生成bash脚本内容
            let scriptContent = `#!/bin/bash
# 自动生成的SSH批量操作脚本
# 生成时间: ${new Date().toLocaleString()}

# 配置参数
SSH_PASSWORD="${sshPassword}"
SSH_USER="${sshUser}"
SSH_IP="${sshIp}"
NUM_TERMINALS=${numTerminals}
BASE_SCRIPT="${scriptPrefix}"
WORK_DIR="${workingDir}"
ENV_COMMAND="${envCommand}"

# 检查依赖
if ! command -v expect &> /dev/null; then
    echo "错误：未安装expect工具，请先安装"
    exit 1
fi

if ! command -v gnome-terminal &> /dev/null && ! command -v konsole &> /dev/null; then
    echo "错误：未检测到支持的终端模拟器"
    exit 1
fi

`;

            // 添加目录配置数组
            scriptContent += `# 目录配置
declare -a INPUT_DIRS=(
`;
            dirConfigs.forEach(config => {
                scriptContent += `    "${config.input}"\n`;
            });
            scriptContent += `)

declare -a OUTPUT_DIRS=(
`;
            dirConfigs.forEach(config => {
                scriptContent += `    "${config.output}"\n`;
            });
            scriptContent += `)

`;

            // 添加主循环
            scriptContent += `# 启动终端会话
for ((i=1; i<=NUM_TERMINALS; i++)); do
    SCRIPT_NUM=$i
    INPUT_DIR="\${INPUT_DIRS[\$i-1]}"
    OUTPUT_DIR="\${OUTPUT_DIRS[\$i-1]}"
    SCRIPT_FILE="\${BASE_SCRIPT}\${SCRIPT_NUM}.sh"
    
    # 选择终端类型
    if command -v gnome-terminal &> /dev/null; then
        TERMINAL_CMD="gnome-terminal --title 'SSH Terminal \$i (\$SCRIPT_FILE)' -- bash -c"
    else
        TERMINAL_CMD="konsole --title 'SSH Terminal \$i (\$SCRIPT_FILE)' -e bash -c"
    fi

    # 执行终端命令
    \$TERMINAL_CMD "
        expect -c '
            spawn ssh \$SSH_USER@\$SSH_IP
            expect \"password: \"
            send \"\$SSH_PASSWORD\r\"
            expect \"\$SSH_USER@*\"
            
            # 激活环境并进入工作目录
            send \"\$ENV_COMMAND\r\"
            expect \"(*) \$SSH_USER@*\"
            send \"cd \$WORK_DIR\r\"
            expect \"(*) \$SSH_USER@*:\$WORK_DIR\"
            
            # 提示信息
            send \"echo 正在编辑 \$SCRIPT_FILE...\r\"
            send \"echo 请确认或修改以下路径：\r\"
            send \"echo INPUT_DIR: \$INPUT_DIR\r\"
            send \"echo OUTPUT_DIR: \$OUTPUT_DIR\r\"
            send \"sleep 3\r\"
            
            # 编辑脚本
            send \"vim \$SCRIPT_FILE\r\"
            expect eof  # 等待用户完成编辑
            
            # 运行脚本
            send \"echo 开始运行 \$SCRIPT_FILE...\r\"
            send \"./\$SCRIPT_FILE\r\"
            interact
        '
    " &
    
    sleep 1
done

echo "已启动所有 \$NUM_TERMINALS 个终端会话"
`;

            // 创建并下载脚本文件
            const blob = new Blob([scriptContent], { type: 'text/x-sh' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'start_ssh_sessions.sh';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logMessage('已生成启动脚本，请保存并运行');
            return true;
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 生成初始配置项
            generateScriptConfigs();
            
            // 绑定生成配置项按钮事件
            document.getElementById('generate-configs').addEventListener('click', generateScriptConfigs);
            
            // 绑定启动会话按钮事件
            document.getElementById('start-sessions').addEventListener('click', () => {
                logMessage('准备生成启动脚本...');
                if (generateAndDownloadScript()) {
                    logMessage('请在终端中运行以下命令：');
                    logMessage('chmod +x start_ssh_sessions.sh');
                    logMessage('./start_ssh_sessions.sh');
                }
            });
        });
    </script>
</body>
</html>
    